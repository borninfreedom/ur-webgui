ROSLIB.RWTPlot=function(a){this.max_data=a.max_data||100,this.use_timestamp=a.timestamp,this.plot=null,this.drawingp=!1,this.clearData()},ROSLIB.RWTPlot.prototype.clearData=function(){this.data=this.use_timestamp?[]:new ROSLIB.RingBuffer({bufferCount:this.max_data}),this.need_to_animate=!1,this.spec&&($("#"+this.content.attr("id")).find("svg").remove(),this.initializePlot(this.content,this.spec))},ROSLIB.RWTPlot.prototype.initializePlot=function(a,b){this.spec=b||{},this.content=a;var c=a.width(),d=a.height(),e=b.margin||{top:20,right:20,bottom:20,left:40},f=this,g=b.yaxis||{},h=g.min||0,i=g.max||1,j=g.tick||!1;this.y_autoscale=g.auto_scale||!1,this.y_min_value=h,this.y_max_value=i,this.y_autoscale_margin=g.auto_scale_margin||.2,this.yaxis_tick=j,this.x_scale=this.use_timestamp?d3.time.scale().range([0,c-e.left-e.right]):d3.scale.linear().domain([0,this.max_data-1]).range([0,c-e.left-e.right]),this.y_scale=this.y_autoscale?d3.scale.linear().domain(this.axisMinMaxWithMargin(this.y_min_value,this.y_max_value,this.y_autoscale_margin)).range([d-e.top-e.bottom,0]):d3.scale.linear().domain([h,i]).range([d-e.top-e.bottom,0]),this.svg=d3.select("#"+a.attr("id")).append("svg").attr("class","rwt-plot").attr("width",c).attr("height",d).append("g").attr("transform","translate("+e.left+","+e.top+")"),this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",c-e.left-e.right).attr("height",d-e.top-e.bottom),this.x=d3.svg.axis().scale(this.x_scale).orient("bottom").ticks(3).tickFormat(function(a){return a.getTime()/1e3}),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.y_scale(0)+")").call(this.x),this.y=d3.svg.axis().scale(this.y_scale).orient("left"),this.yaxis_tick&&(this.y=this.y.ticks(this.yaxis_tick)),this.svg.append("g").attr("class","y axis").call(this.y),this.line=this.use_timestamp?d3.svg.line().x(function(a){return f.x_scale(a[0].toDate())}).y(function(a){return f.y_scale(a[1])}):d3.svg.line().x(function(a,b){return f.x_scale(b)}).y(function(a){return f.y_scale(a)}),this.color=d3.scale.category10(),this.paths=[]},ROSLIB.RWTPlot.prototype.allocatePath=function(a){var b=this;return this.color.domain(_.range(a)),this.svg.append("g").attr("clip-path","url(#clip)").append("path").datum([]).attr("class","line line"+a).style("stroke",function(){return b.color(a-1)}).attr("d",this.line)},ROSLIB.RWTPlot.prototype.axisMinMaxWithMargin=function(a,b,c){var d=(b+a)/2,e=(a-d)*(1+c)+d,f=(b-d)*(1+c)+d;return[e,f]},ROSLIB.RWTPlot.prototype.checkYAxisMinMax=function(a){for(var b=!1,c=0;c<a.length;c++){var d=a[c];d<this.y_min_value&&(this.y_min_value=d,b=!0),d>this.y_max_value&&(this.y_max_value=d,b=!0)}if(b){this.y_scale.domain(this.axisMinMaxWithMargin(this.y_min_value,this.y_max_value,this.y_autoscale_margin));var e=d3.svg.axis().scale(this.y_scale).orient("left");this.yaxis_tick&&(e=e.ticks(this.yaxis_tick)),this.svg.select(".y.axis").call(e)}},ROSLIB.RWTPlot.prototype.addRawData=function(a){var b=_.isArray(a)?a.length:0;0===b&&(a=[a]),this.y_autoscale&&this.checkYAxisMinMax(a);ROSLIB.Time.now();this.data.push(a);var c=this.data.toArray(),d=_.zip(c);if(this.paths.length<a.length)for(var e=this.paths.length;e<a.length;e++)this.paths.push(this.allocatePath(e%7));for(var f=0;f<d.length;f++){var g=d[f];this.need_to_animate?this.paths[f].datum(g).attr("d",this.line).attr("transform",null).transition().ease("linear").attr("transform","translate("+this.x_scale(-1)+",0)"):this.paths[f].datum(g).attr("d",this.line).attr("transform",null).transition()}this.data.length()===this.max_data&&(this.need_to_animate=!0)},ROSLIB.ROSTimeToSec=function(a){return a.secs+a.nsecs/1e9},ROSLIB.ROSTimeDifference=function(a,b){return a.secs-b.secs+(a.nsecs-b.nsecs)/1e9},ROSLIB.RWTPlot.prototype.chopTimestampedData=function(a){if(this.data.length>0){for(var b=0,c=0;c<this.data.length;c++){var d=a.substract(this.data[c].stamp).toSec();if(!(d>this.max_data))break;b+=1}return this.data=this.data.slice(b),b>0}return!1},ROSLIB.RWTPlot.prototype.addTimestampedData=function(a,b){var c=_.isArray(b)?b.length:0;if(0===c&&(b=[b]),this.y_autoscale&&this.checkYAxisMinMax(b),this.paths.length<b.length)for(var d=this.paths.length;d<b.length;d++)this.paths.push(this.allocatePath(d%7));var e=null;this.data.length>0&&(e=this.data[0].stamp);var f=this.chopTimestampedData(a,b);if(b.stamp=a,this.data.push(b),!(this.data.length<1)){var g=this.data[0].stamp;this.x_scale.domain([g.toDate(),g.add(ROSLIB.Time.fromSec(this.max_data)).toDate()]),this.x.scale(this.x_scale),this.svg.select(".x.axis").call(this.x);for(var h=0;h<b.length;h++){for(var i=[],j=0;j<this.data.length;j++){var k=this.data[j][h];if(!a.equal(g)){var l=(this.data[j].stamp.substract(g).toSec(),[this.data[j].stamp,k]);i.push(l)}}if(f){var m=g.substract(e).toSec();this.paths[h].datum(i).attr("d",this.line).attr("transform",null).transition().ease("linear").attr("transform","translate("+-m+",0)")}else this.paths[h].datum(i).attr("d",this.line).attr("transform",null).transition()}}},ROSLIB.RWTPlot.prototype.addData=function(a,b){this.use_timestamp?this.addTimestampedData(a,b):this.addRawData(a)},ROSLIB.profile=function(a){var b=ROSLIB.Time.now();a.call();var c=ROSLIB.Time.now(),d=c.substract(b);console.log("profile: "+d.toSec())},ROSLIB.RingBuffer=function(a){this.bufferCount=(a||{}).bufferCount||100,this.clear()},ROSLIB.RingBuffer.prototype.push=function(a){return this.endIndex++,this.endIndex===this.bufferCount&&(this.endIndex=0),this.count>=this.bufferCount?(this.buffer[this.endIndex]=a,this.startIndex++,this.startIndex===this.bufferCount&&(this.startIndex=0)):this.buffer[this.endIndex]=a,this.count++,a},ROSLIB.RingBuffer.prototype.clear=function(){this.buffer=new Array(this.bufferCount),this.startIndex=0,this.endIndex=-1,this.count=0},ROSLIB.RingBuffer.prototype.map=function(a){for(var b=[],c=this.startIndex;c<Math.min(this.count,this.bufferCount);c++)b.push(a.call(this,this.buffer[c]));if(this.count>this.bufferCount)for(var d=0;d<this.endIndex+1;d++)b.push(a.call(this,this.buffer[d]));return b},ROSLIB.RingBuffer.prototype.toArray=function(){return this.map(function(a){return a})},ROSLIB.RingBuffer.prototype.length=function(){return Math.min(this.bufferCount,this.count)},ROSLIB.Ros.prototype.getTopicType=function(a,b){var c=new ROSLIB.Service({ros:this,name:"/rosapi/topic_type",serviceType:"rosapi/TopicType"}),d=new ROSLIB.ServiceRequest({topic:a});c.callService(d,function(a){b(a.type)})},ROSLIB.Ros.prototype.getMessageDetails=function(a,b){var c=new ROSLIB.Service({ros:this,name:"/rosapi/message_details",serviceType:"rosapi/MessageDetails"}),d=new ROSLIB.ServiceRequest({type:a});c.callService(d,function(a){b(a.typedefs)})},ROSLIB.Ros.prototype.decodeTypeDefs=function(a){var b=(a[0],function(a,c){for(var d={},e=0;e<a.fieldnames.length;e++){var f=a.fieldarraylen[e],g=a.fieldnames[e],h=a.fieldtypes[e];if(-1===h.indexOf("/"))d[g]=-1===f?h:[h];else{for(var i=!1,j=0;j<c.length;j++)if(c[j].type.toString()===h.toString()){i=c[j];break}if(!i)throw"cannot find "+h;var k=b(i,c);d[g]=-1===f?k:[k]}}return d});return b(a[0],a)},ROSLIB.Time=function(a){this.nsecs=Math.floor((a||{}).nsecs||0),this.secs=Math.floor((a||{}).secs||0)},ROSLIB.Time.now=function(){var a=new Date,b=a.getTime();return new ROSLIB.Time({secs:Math.floor(b/1e3),nsecs:b%1e3*1e6})},ROSLIB.Time.prototype.toSec=function(){return this.secs+this.nsecs/1e9},ROSLIB.Time.prototype.toMillSec=function(){return 1e3*this.secs+this.nsecs/1e6},ROSLIB.Time.prototype.add=function(a){var b=this.secs+a.secs,c=this.nsecs+a.nsecs;return c>1e9&&(b+=1,c-=1e9),new ROSLIB.Time({secs:b,nsecs:c})},ROSLIB.Time.prototype.substract=function(a){var b=this.secs-a.secs,c=this.nsecs-a.nsecs;return 0>c&&(b-=1,c=1e9+c),new ROSLIB.Time({secs:b,nsecs:c})},ROSLIB.Time.prototype.equal=function(a){var b=this.substract(a);return 0===b.secs&&0===b.nsecs},ROSLIB.Time.fromROSMsg=function(a){return new ROSLIB.Time({secs:a.secs,nsecs:a.nsecs})},ROSLIB.Time.fromSec=function(a){return new ROSLIB.Time({secs:a,nsecs:0})},ROSLIB.Time.prototype.toDate=function(){var a=new Date;return a.setTime(1e3*this.secs+this.nsecs/1e6),a};